{% extends 'base.html' %}
{% load static %}

{% block content %}
<section class="profile-container__ container">
	<header class="profile-header text-center">
		<article class="profile-details">
			<div class="profile-image-container position-relative">
				<img loading="lazy" src="{{ profile_image.url }}" alt="profile picture" class="profile-image img-fluid rounded-circle" />
				<span class="status-indicator position-absolute {% if is_online %} online {% else %} offline {% endif %}"></span>
			</div>
			<h2 class="profile-name">{{ username }}</h2>
			<div class="profile-actions d-flex justify-content-center mt-3 gap-2">
				{% if is_own_profile %}
					<button class="btn btn-outline-light profile-action-edit" id="edit_profile">Edit</button>
				{% else %}
					{% if are_friends %}
						<button class="btn btn-danger rounded-pill profile-action-remove-friend" onclick="removeFriend('{{username}}')">Remove Friend</button>
					{% elif sent_request %}
						<button class="btn btn-secondary rounded-pill profile-action-request-sent" disabled>Request Sent</button>
					{% elif received_request %}
						<button class="btn btn-success rounded-pill profile-action-accept-friend" onclick="location.href='{% url 'accept_friend_request' username %}'">Accept Friend</button>
					{% endif %}
					<button class="btn btn-primary profile-action-play">Play</button>
				{% endif %}
			</div>
		</article>
	</header>

	<section class="stats-section my-4">
		<div class="row stats-container">
			<div class="col-md-4 stats-column">
				<div class="stats-item text-center py-3">
					<div class="stats-content">
						<span class="stats-number">{{ total_games }}</span>
						<p class="stats-label">Games</p>
					</div>
				</div>
			</div>
			<div class="col-md-4 stats-column">
				<div class="stats-item text-center py-3">
					<div class="stats-content">
						<span class="stats-number">{{ total_wins }}</span>
						<p class="stats-label">Wins</p>
					</div>
				</div>
			</div>
			<div class="col-md-4 stats-column">
				<div class="stats-item text-center py-3">
					<div class="stats-content">
						<span class="stats-number">{{ total_losses }}</span>
						<p class="stats-label">Losses</p>
					</div>
				</div>
			</div>
		</div>
	</section>

	<nav class="highlighted-tab d-flex justify-content-between border-bottom py-2 mb-3">
		<div class="highlighted-label" id="stats-tab">Stats</div>
		<div class="highlighted-stats active" id="history-tab">History</div>
		<div class="highlighted-friends" id="friends-tab">Friends</div>
		{% if is_own_profile %}
			<div class="highlighted-requests" id="requests-tab">Requests</div>
		{% endif %}
	</nav>

	<section id="history-section" class="history-section">
		{% if games|length == 0 %}
			<div class="history-item d-flex justify-content-between align-items-center py-2">
				<div class="d-flex align-items-center gap-3">
					<div class="history-details">
						<span class="history-title">No games played yet</span>
					</div>
				</div>
			</div>
		{% endif %}
		{% for match in games %}
			<div class="history-item d-flex justify-content-between align-items-center py-2">
				<div class="d-flex align-items-center gap-3">
					<div class="rounded-circle {% if match.winner.username == username %} alert alert-primary {% else %} alert alert-danger {% endif %}" style="width: 56px; height: 56px;"></div>
					<div class="history-details">
						{% if match.winner.username == username %}
							{% if match.player1.username == username %}
								<span class="history-title">You won against {{ match.player2.username }}</span>
							{% else %}
								<span class="history-title">You won against {{ match.player1.username }}</span>
							{% endif %}
						{% else %}
							{% if match.player1.username == username %}
								<span class="history-title">You lost to {{ match.player2.username }}</span>
							{% else %}
								<span class="history-title">You lost to {{ match.player1.username }}</span>
							{% endif %}
						{% endif %}
						<time class="history-time">{{ match.date }}</time>
					</div>
				</div>
				<span class="history-score">{{ match.player1_score }} - {{ match.player2_score }}</span>
			</div>
		{% endfor %}
	</section>

	<section id="friends-section" class="friends-section d-none">
		<div id="friends-list" class="list-container">
			{% if friends|length == 0 %}
				<div class="friend-item d-flex justify-content-between align-items-center py-2">
					<div class="d-flex align-items-center gap-3">
						<div class="friend-details">
							<span class="friend-name">No friends found</span>
						</div>
					</div>
				</div>
			{% endif %}
			{% for friend in friends %}
				<div class="friend-item d-flex justify-content-between align-items-center py-2">
					<div class="d-flex align-items-center gap-3 col-6">
						<a href="#" onclick="loadProfile('{{ friend.username }}'); return false;">
							<img loading="lazy" src="{{ friend.profile.image.url }}" alt="Friend's profile image" class="friend-image rounded-circle" />
						</a>
						<div class="friend-details">
							<a href="#" onclick="loadProfile('{{ friend.username }}'); return false;" class="friend-name">{{ friend.username }}</a>
						</div>
					</div>
					<div>
						<p>{{ friend.date_joined|date:"d/m/y" }}</p>
					</div>
				</div>
			{% endfor %}
		</div>
		{% if is_own_profile %}
			<div id="non-friends-list" class="list-container mt-4">
				<div class="search-bar">
					<i class="fas fa-search search-icon"></i>
					<input type="text" class="search-input" placeholder="Search Players">
				</div>
				{% for non_friend in non_friends %}
					<div class="friend-item d-flex justify-content-between align-items-center py-2">
						<div class="d-flex align-items-center gap-3 col-6">
							<a href="#" onclick="loadProfile('{{ non_friend.username }}'); return false;">
								<img loading="lazy" src="{{ non_friend.profile.image.url }}" alt="Non-friend's profile image" class="friend-image rounded-circle" />
							</a>
							<div class="friend-details">
								<a href="#" onclick="loadProfile('{{ non_friend.username }}'); return false;" class="friend-name">{{ non_friend.username }}</a>
							</div>
						</div>
						<div>
							<p>{{ non_friend.date_joined|date:"d/m/y" }}</p>
						</div>
					</div>
				{% endfor %}
			</div>
		{% endif %}
	</section>

	{% if is_own_profile %}
	<section id="requests-section" class="requests-section d-none">
		<div id="requests-list" class="list-container">
			{% if received_requests|length == 0 %}
				<div class="request-item d-flex justify-content-between align-items-center py-2">
					<div class="d-flex align-items-center gap-3">
						<div class="request-details">
							<span class="request-name">No friend requests</span>
						</div>
					</div>
				</div>
			{% endif %}
			{% for requester in received_requests %}
				<div class="request-item d-flex justify-content-between align-items-center py-2">
					<div class="d-flex align-items-center gap-3 col-6">
						<a href="#" onclick="loadProfile('{{ requester.username }}'); return false;">
							<img loading="lazy" src="{{ requester.profile.image.url }}" alt="Requester's profile image" class="request-image rounded-circle" />
						</a>
						<div class="request-details">
							<a href="#" onclick="loadProfile('{{ requester.username }}'); return false;" class="request-name">{{ requester.username }}</a>
						</div>
					</div>
					<div>
						<button class="btn btn-success rounded-pill" onclick="location.href='{% url 'accept_friend_request' requester.username %}'">Accept</button>
						<button class="btn btn-danger rounded-pill" onclick="location.href='{% url 'reject_friend_request' requester.username %}'">Reject</button>
					</div>
				</div>
			{% endfor %}
		</div>
	</section>
	{% endif %}

	<section id="stats-section" class="stats-section d-none">
		<canvas id="gamesChart" width="400" height="200"></canvas>
	</section>
	<script id="gamesData" type="application/json">{{ games2|safe }}</script>
	<script>
		const user_id = {{ user.id }};
	</script>
</section>
{% endblock %}
